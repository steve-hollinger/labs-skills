# Example 4: RDS Database Dependency
# A financial service connecting to RDS PostgreSQL
# Demonstrates database connections, pooling, and caching

name: transaction-service
platform: ecs
description: Financial transaction processing with PostgreSQL backend

team: finance-team
tags:
  environment: production
  compliance: pci-dss
  tier: critical
  cost-center: finance

compute:
  cpu: 1024
  memory: 2048
  desired_count: 5

networking:
  port: 8443
  protocol: https
  health_check:
    path: /health
    interval: 10
    timeout: 5

# RDS and supporting dependencies
dependencies:
  # Primary PostgreSQL database
  - type: aws_rds_instance
    name: transactions-primary
    database: transactions_db
    credentials: ${secrets:transaction-service/db-primary}
    ssl_mode: verify-full

    # Connection pooling settings
    connection:
      max_connections: 20
      min_connections: 5
      idle_timeout: 300
      connection_timeout: 10
      statement_timeout: 30000

    # Read/write access
    mode: read_write

  # Read replica for reporting queries
  - type: aws_rds_instance
    name: transactions-replica
    database: transactions_db
    credentials: ${secrets:transaction-service/db-replica}
    ssl_mode: verify-full

    connection:
      max_connections: 10
      min_connections: 2
      idle_timeout: 600

    # Read-only access for reporting
    mode: read

  # Redis cache for session and rate limiting
  - type: aws_elasticache
    name: transaction-cache
    engine: redis
    mode: read_write

    cluster:
      mode: cluster
      node_type: cache.r6g.large
      num_shards: 3
      replicas_per_shard: 2

    # Encryption in transit and at rest
    encryption:
      at_rest: true
      in_transit: true
      auth_token: ${secrets:transaction-service/redis-auth}

  # Audit log bucket for compliance
  - type: aws_s3_bucket
    name: transaction-audit-logs
    mode: write
    encryption:
      enabled: true
      kms_key: ${kms:audit-key}

    # Compliance: no deletion allowed
    object_lock:
      enabled: true
      mode: COMPLIANCE
      retention_days: 2555  # 7 years

  # SNS topic for transaction notifications
  - type: aws_sns_topic
    name: transaction-notifications
    mode: producer

  # DynamoDB for idempotency tracking
  - type: aws_dynamodb_table
    name: transaction-idempotency
    mode: read_write

environment:
  DB_PRIMARY_HOST: ${rds:transactions-primary:endpoint}
  DB_REPLICA_HOST: ${rds:transactions-replica:endpoint}
  DB_NAME: transactions_db
  DB_PORT: "5432"
  DB_SSL_MODE: verify-full
  REDIS_URL: ${elasticache:transaction-cache:url}
  AUDIT_BUCKET: transaction-audit-logs
  LOG_LEVEL: info
  LOG_FORMAT: json
