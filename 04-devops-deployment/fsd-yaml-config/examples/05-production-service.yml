# Example 5: Production-Ready Service
# A comprehensive production configuration demonstrating all best practices
# Use this as a template for critical production services

name: payment-gateway
platform: ecs
description: Payment processing service with PCI-DSS compliance requirements

team: payments-team
tags:
  environment: production
  compliance: pci-dss
  tier: critical
  cost-center: payments
  data-classification: confidential
  on-call-team: payments-oncall

# Production compute configuration
compute:
  cpu: 1024           # 1 vCPU
  memory: 2048        # 2 GB
  desired_count: 5    # Minimum for high availability

  # Use standard Fargate for predictable performance
  capacity_provider: FARGATE

  # Container settings
  container:
    image: ${ecr:payment-gateway}:${git:sha}
    essential: true
    readonly_root_filesystem: true
    privileged: false
    user: "1000:1000"

# Comprehensive networking configuration
networking:
  port: 8443
  protocol: https

  # Aggressive health checking for critical service
  health_check:
    path: /health
    port: 8443
    protocol: HTTPS
    interval: 10        # Check every 10 seconds
    timeout: 5
    healthy_threshold: 2
    unhealthy_threshold: 2

  # Internal ALB - no public access
  load_balancer:
    type: application
    internal: true
    idle_timeout: 120
    ssl_policy: ELBSecurityPolicy-TLS13-1-2-2021-06

    # WAF integration
    waf:
      enabled: true
      web_acl_arn: ${ssm:/payments/waf-acl-arn}

  # Service discovery for internal communication
  service_discovery:
    namespace: payments.internal
    dns_ttl: 10

# Autoscaling for variable load
scaling:
  min_count: 5
  max_count: 50

  policies:
    # Scale on CPU utilization
    - type: target_tracking
      metric: cpu
      target: 60
      scale_in_cooldown: 300
      scale_out_cooldown: 60

    # Scale on request count
    - type: target_tracking
      metric: alb_request_count
      target: 1000
      scale_in_cooldown: 300
      scale_out_cooldown: 60

    # Scheduled scaling for known peak times
    - type: scheduled
      schedule: "cron(0 9 * * MON-FRI)"
      min_capacity: 10
      max_capacity: 50
      timezone: America/New_York

# Comprehensive observability
observability:
  logging:
    driver: awslogs
    options:
      log_group: /ecs/payment-gateway
      stream_prefix: ecs
    retention_days: 90

  tracing:
    enabled: true
    provider: xray
    sampling_rate: 0.1

  metrics:
    enabled: true
    namespace: PaymentGateway
    custom:
      - name: PaymentSuccessRate
        unit: Percent
      - name: TransactionLatency
        unit: Milliseconds
      - name: FraudDetectionRate
        unit: Count

  # Alarms for critical metrics
  alarms:
    - name: HighErrorRate
      metric: HTTPCode_Target_5XX_Count
      threshold: 10
      evaluation_periods: 2
      period: 60
      comparison: GreaterThanThreshold
      actions:
        - ${sns:payments-alerts}

    - name: HighLatency
      metric: TargetResponseTime
      threshold: 2000
      evaluation_periods: 3
      period: 60
      comparison: GreaterThanThreshold
      actions:
        - ${sns:payments-alerts}

# Security hardening
security:
  # Task role with least privilege
  task_role: ${iam:payment-gateway-task-role}
  execution_role: ${iam:payment-gateway-execution-role}

  # Network isolation
  network_mode: awsvpc
  security_groups:
    - ${sg:payment-gateway}

  # Container hardening
  readonly_root_filesystem: true
  no_new_privileges: true
  drop_capabilities:
    - ALL
  add_capabilities:
    - NET_BIND_SERVICE

# Environment variables - all secrets from Secrets Manager
environment:
  # Application configuration
  LOG_LEVEL: info
  LOG_FORMAT: json
  PORT: "8443"
  TLS_ENABLED: "true"

  # Secrets references
  DATABASE_URL: ${secrets:payment-gateway/database-url}
  PAYMENT_PROCESSOR_API_KEY: ${secrets:payment-gateway/processor-api-key}
  ENCRYPTION_KEY: ${secrets:payment-gateway/encryption-key}
  JWT_SIGNING_KEY: ${secrets:payment-gateway/jwt-key}

  # Configuration from Parameter Store
  FEATURE_FLAGS: ${ssm:/payment-gateway/feature-flags}
  RATE_LIMIT_CONFIG: ${ssm:/payment-gateway/rate-limits}

  # Service discovery
  FRAUD_SERVICE_URL: ${service:fraud-detector:url}
  NOTIFICATION_SERVICE_URL: ${service:notification-service:url}

# Deployment configuration
deployment:
  type: rolling
  minimum_healthy_percent: 100   # Never go below current capacity
  maximum_percent: 200          # Allow double capacity during deployment

  # Circuit breaker to fail fast on bad deployments
  circuit_breaker:
    enabled: true
    rollback: true

# Dependencies on other FSD services
dependencies:
  - type: aws_secrets_manager
    name: payment-gateway-secrets
    secrets:
      - database-url
      - processor-api-key
      - encryption-key
      - jwt-key

  - type: aws_dynamodb_table
    name: payment-transactions
    mode: read_write

  - type: aws_sqs_queue
    name: payment-notifications
    mode: producer
