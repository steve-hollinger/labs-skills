# Example 2: EKS Worker Service
# A Kubernetes worker deployment that processes messages from a queue
# Demonstrates EKS-specific configuration with autoscaling

name: order-processor
platform: eks
description: Processes orders from SQS queue

team: orders-team
tags:
  environment: staging
  tier: backend
  cost-center: operations

# EKS compute uses Kubernetes resource specifications
compute:
  replicas: 3

  # Resource requests and limits
  resources:
    requests:
      cpu: "250m"        # 250 millicores = 0.25 vCPU
      memory: "256Mi"    # 256 mebibytes
    limits:
      cpu: "500m"        # Max 0.5 vCPU
      memory: "512Mi"    # Max 512 MiB

  # Horizontal Pod Autoscaler configuration
  autoscaling:
    enabled: true
    min_replicas: 2
    max_replicas: 20
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 70
      - type: Resource
        resource:
          name: memory
          target:
            type: Utilization
            averageUtilization: 80

# Pod scheduling constraints
scheduling:
  node_selector:
    workload-type: workers
  tolerations:
    - key: dedicated
      operator: Equal
      value: workers
      effect: NoSchedule

# Liveness and readiness probes
probes:
  liveness:
    exec:
      command:
        - /bin/sh
        - -c
        - pgrep -f "order-processor"
    initial_delay_seconds: 10
    period_seconds: 30
  readiness:
    http_get:
      path: /ready
      port: 8081
    initial_delay_seconds: 5
    period_seconds: 10

# Environment variables
environment:
  QUEUE_URL: ${ssm:/order-processor/queue-url}
  BATCH_SIZE: "10"
  VISIBILITY_TIMEOUT: "300"
  LOG_FORMAT: json
  OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
